# Generated by Django 5.1.4 on 2025-12-09 06:46

import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('ai_assistants', '0006_fieldextraction_receipt_unrecognized_reason_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='AIRequestLog',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('request_id', models.CharField(db_index=True, max_length=100, unique=True)),
                ('trace_id', models.CharField(blank=True, db_index=True, help_text='Distributed tracing ID', max_length=100)),
                ('tenant_id', models.CharField(blank=True, db_index=True, max_length=100)),
                ('request_type', models.CharField(choices=[('CHAT', 'Chat Completion'), ('EMBEDDING', 'Embedding'), ('RAG', 'RAG Query'), ('EXTRACTION', 'Data Extraction'), ('CLASSIFICATION', 'Classification'), ('SUMMARIZATION', 'Summarization'), ('TRANSLATION', 'Translation'), ('CODE_GEN', 'Code Generation')], default='CHAT', max_length=20)),
                ('status', models.CharField(choices=[('SUCCESS', 'Success'), ('FAILED', 'Failed'), ('TIMEOUT', 'Timeout'), ('RATE_LIMITED', 'Rate Limited'), ('CACHED', 'Served from Cache')], default='SUCCESS', max_length=20)),
                ('provider', models.CharField(db_index=True, help_text='openai, anthropic, google, deepseek', max_length=50)),
                ('model', models.CharField(db_index=True, help_text='gpt-4o, claude-3-opus, etc.', max_length=100)),
                ('prompt_tokens', models.IntegerField(default=0)),
                ('completion_tokens', models.IntegerField(default=0)),
                ('total_tokens', models.IntegerField(default=0)),
                ('estimated_cost_cents', models.IntegerField(default=0, help_text='Estimated cost in cents')),
                ('latency_ms', models.IntegerField(default=0, help_text='Total request latency')),
                ('ttfb_ms', models.IntegerField(blank=True, help_text='Time to first byte', null=True)),
                ('prompt_preview', models.TextField(blank=True, help_text='First 500 chars of prompt')),
                ('response_preview', models.TextField(blank=True, help_text='First 500 chars of response')),
                ('endpoint', models.CharField(blank=True, help_text='API endpoint called', max_length=200)),
                ('assistant_type', models.CharField(blank=True, help_text='analyst, planner, accounting, etc.', max_length=50)),
                ('error_type', models.CharField(blank=True, max_length=100)),
                ('error_message', models.TextField(blank=True)),
                ('retry_count', models.IntegerField(default=0)),
                ('cache_hit', models.BooleanField(default=False)),
                ('cache_key', models.CharField(blank=True, max_length=255)),
                ('user', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='ai_requests', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'AI Request Log',
                'verbose_name_plural': 'AI Request Logs',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='AIResultLog',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('result_id', models.CharField(db_index=True, max_length=255, unique=True)),
                ('result_type', models.CharField(db_index=True, default='general', max_length=100)),
                ('source_content', models.TextField(blank=True, help_text='Original input content or reference')),
                ('input_type', models.CharField(blank=True, help_text='image, document, text, etc.', max_length=50)),
                ('input_hash', models.CharField(blank=True, help_text='Hash of input for deduplication', max_length=64)),
                ('input_metadata', models.JSONField(blank=True, default=dict)),
                ('extracted_fields', models.JSONField(blank=True, default=list, help_text='List of extracted fields with structure: [{field_name, value, confidence, source_location, alternatives}]')),
                ('output_data', models.JSONField(default=dict, help_text='Full AI extraction result')),
                ('overall_confidence', models.FloatField(default=0.0)),
                ('reasoning', models.JSONField(default=dict, help_text='AI reasoning for each field')),
                ('classification_factors', models.JSONField(default=list, help_text='Factors that influenced classification')),
                ('alternatives_considered', models.JSONField(default=dict, help_text='Alternative values/classifications')),
                ('model_provider', models.CharField(blank=True, help_text='AI provider used', max_length=50)),
                ('model_name', models.CharField(blank=True, help_text='Model name/version', max_length=100)),
                ('model_version', models.CharField(blank=True, max_length=50)),
                ('processing_time_ms', models.IntegerField(blank=True, null=True)),
                ('tokens_used', models.IntegerField(blank=True, null=True)),
                ('feedback_count', models.IntegerField(default=0)),
                ('positive_feedback_count', models.IntegerField(default=0)),
                ('negative_feedback_count', models.IntegerField(default=0)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='ai_result_logs', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='AIUsageSummary',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('date', models.DateField(db_index=True)),
                ('period_type', models.CharField(choices=[('DAILY', 'Daily'), ('WEEKLY', 'Weekly'), ('MONTHLY', 'Monthly')], default='DAILY', max_length=20)),
                ('tenant_id', models.CharField(db_index=True, max_length=100)),
                ('total_requests', models.IntegerField(default=0)),
                ('successful_requests', models.IntegerField(default=0)),
                ('failed_requests', models.IntegerField(default=0)),
                ('total_prompt_tokens', models.BigIntegerField(default=0)),
                ('total_completion_tokens', models.BigIntegerField(default=0)),
                ('total_tokens', models.BigIntegerField(default=0)),
                ('total_cost_cents', models.IntegerField(default=0)),
                ('usage_by_provider', models.JSONField(blank=True, default=dict, help_text='{provider: {tokens, cost, requests}}')),
                ('usage_by_model', models.JSONField(blank=True, default=dict, help_text='{model: {tokens, cost, requests}}')),
                ('usage_by_type', models.JSONField(blank=True, default=dict, help_text='{type: {tokens, cost, requests}}')),
                ('avg_latency_ms', models.IntegerField(default=0)),
                ('p95_latency_ms', models.IntegerField(default=0)),
                ('p99_latency_ms', models.IntegerField(default=0)),
                ('total_vector_searches', models.IntegerField(default=0)),
                ('avg_results_per_search', models.FloatField(default=0.0)),
                ('avg_similarity_score', models.FloatField(default=0.0)),
                ('knowledge_gaps_detected', models.IntegerField(default=0)),
            ],
            options={
                'verbose_name': 'AI Usage Summary',
                'verbose_name_plural': 'AI Usage Summaries',
                'ordering': ['-date'],
                'indexes': [models.Index(fields=['tenant_id', 'date'], name='ai_assistan_tenant__f5062e_idx'), models.Index(fields=['period_type', 'date'], name='ai_assistan_period__25ab18_idx')],
                'unique_together': {('date', 'period_type', 'tenant_id')},
            },
        ),
        migrations.CreateModel(
            name='AsyncTask',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('celery_task_id', models.CharField(db_index=True, max_length=255, unique=True)),
                ('task_type', models.CharField(choices=[('OCR_PROCESS', 'OCR Processing'), ('DOCUMENT_ANALYSIS', 'Document Analysis'), ('REPORT_GENERATION', 'Report Generation'), ('BULK_IMPORT', 'Bulk Import'), ('AI_ANALYSIS', 'AI Analysis'), ('DATA_EXPORT', 'Data Export'), ('EMAIL_PROCESSING', 'Email Processing')], default='AI_ANALYSIS', max_length=50)),
                ('name', models.CharField(help_text='Human-readable task name', max_length=255)),
                ('description', models.TextField(blank=True)),
                ('status', models.CharField(choices=[('PENDING', 'Pending'), ('STARTED', 'Started'), ('PROGRESS', 'In Progress'), ('SUCCESS', 'Success'), ('FAILURE', 'Failed'), ('REVOKED', 'Cancelled')], default='PENDING', max_length=20)),
                ('progress', models.IntegerField(default=0, help_text='Progress percentage 0-100')),
                ('progress_message', models.CharField(blank=True, help_text='Current progress step', max_length=500)),
                ('started_at', models.DateTimeField(blank=True, null=True)),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('estimated_completion', models.DateTimeField(blank=True, null=True)),
                ('result', models.JSONField(blank=True, default=dict, help_text='Task result data')),
                ('result_file', models.FileField(blank=True, null=True, upload_to='task_results/')),
                ('error_message', models.TextField(blank=True)),
                ('error_traceback', models.TextField(blank=True)),
                ('retry_count', models.IntegerField(default=0)),
                ('max_retries', models.IntegerField(default=3)),
                ('input_data', models.JSONField(blank=True, default=dict, help_text='Task input parameters')),
                ('input_files', models.JSONField(blank=True, default=list, help_text='List of input file paths')),
                ('notify_on_complete', models.BooleanField(default=True)),
                ('notification_sent', models.BooleanField(default=False)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='async_tasks', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='TaskWebhook',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('name', models.CharField(max_length=255)),
                ('url', models.URLField()),
                ('task_types', models.JSONField(default=list, help_text='List of task types to trigger webhook (empty = all)')),
                ('secret_key', models.CharField(blank=True, max_length=255)),
                ('headers', models.JSONField(blank=True, default=dict)),
                ('is_active', models.BooleanField(default=True)),
                ('last_triggered', models.DateTimeField(blank=True, null=True)),
                ('failure_count', models.IntegerField(default=0)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='task_webhooks', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='VectorSearchLog',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('tenant_id', models.CharField(blank=True, db_index=True, max_length=100)),
                ('query_text', models.TextField(help_text='Original search query')),
                ('query_embedding_dim', models.IntegerField(default=1536, help_text='Embedding dimension used')),
                ('collection_name', models.CharField(db_index=True, help_text='Vector DB collection', max_length=100)),
                ('namespace', models.CharField(blank=True, help_text='Namespace within collection', max_length=100)),
                ('top_k', models.IntegerField(default=10, help_text='Number of results requested')),
                ('similarity_threshold', models.FloatField(default=0.0, help_text='Minimum similarity score')),
                ('filters_applied', models.JSONField(blank=True, default=dict, help_text='Metadata filters')),
                ('results_count', models.IntegerField(default=0, help_text='Actual results returned')),
                ('avg_similarity_score', models.FloatField(blank=True, help_text='Average similarity of results', null=True)),
                ('max_similarity_score', models.FloatField(blank=True, help_text='Highest similarity score', null=True)),
                ('min_similarity_score', models.FloatField(blank=True, help_text='Lowest similarity score', null=True)),
                ('above_threshold_count', models.IntegerField(default=0, help_text='Results above high confidence threshold (0.8)')),
                ('below_threshold_count', models.IntegerField(default=0, help_text='Results below confidence threshold')),
                ('retrieved_doc_ids', models.JSONField(blank=True, default=list, help_text='IDs of retrieved documents')),
                ('retrieved_scores', models.JSONField(blank=True, default=list, help_text='Similarity scores')),
                ('search_latency_ms', models.IntegerField(default=0, help_text='Vector search latency')),
                ('embedding_latency_ms', models.IntegerField(default=0, help_text='Query embedding latency')),
                ('total_latency_ms', models.IntegerField(default=0)),
                ('rerank_applied', models.BooleanField(default=False)),
                ('rerank_model', models.CharField(blank=True, max_length=100)),
                ('rerank_latency_ms', models.IntegerField(default=0)),
                ('request_log', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='vector_searches', to='ai_assistants.airequestlog')),
                ('user', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='vector_searches', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Vector Search Log',
                'verbose_name_plural': 'Vector Search Logs',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='KnowledgeGapLog',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('tenant_id', models.CharField(blank=True, db_index=True, max_length=100)),
                ('query_text', models.TextField(help_text='Query that exposed the gap')),
                ('gap_type', models.CharField(choices=[('NO_RESULTS', 'No Results Found'), ('LOW_SIMILARITY', 'Low Similarity Scores'), ('IRRELEVANT', 'Results Not Relevant'), ('INCOMPLETE', 'Incomplete Information'), ('OUTDATED', 'Information Outdated'), ('USER_FLAGGED', 'Flagged by User')], max_length=50)),
                ('expected_topic', models.CharField(blank=True, help_text='Topic user was looking for', max_length=200)),
                ('actual_topics', models.JSONField(blank=True, default=list, help_text='Topics actually retrieved')),
                ('similarity_scores', models.JSONField(blank=True, default=list)),
                ('user_feedback', models.TextField(blank=True, help_text='User feedback on why results were poor')),
                ('feedback_rating', models.IntegerField(blank=True, help_text='User rating 1-5', null=True)),
                ('is_resolved', models.BooleanField(default=False)),
                ('resolution_notes', models.TextField(blank=True)),
                ('resolved_at', models.DateTimeField(blank=True, null=True)),
                ('priority', models.CharField(choices=[('LOW', 'Low'), ('MEDIUM', 'Medium'), ('HIGH', 'High'), ('CRITICAL', 'Critical')], default='MEDIUM', max_length=20)),
                ('occurrence_count', models.IntegerField(default=1, help_text='How often this gap occurred')),
                ('resolved_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='resolved_knowledge_gaps', to=settings.AUTH_USER_MODEL)),
                ('user', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='knowledge_gaps', to=settings.AUTH_USER_MODEL)),
                ('vector_search', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='knowledge_gaps', to='ai_assistants.vectorsearchlog')),
            ],
            options={
                'verbose_name': 'Knowledge Gap',
                'verbose_name_plural': 'Knowledge Gaps',
                'ordering': ['-occurrence_count', '-created_at'],
            },
        ),
        migrations.CreateModel(
            name='AIFeedback',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('result_id', models.CharField(db_index=True, help_text='ID of the AI result being reviewed', max_length=255)),
                ('result_type', models.CharField(default='general', help_text='Type of AI result (e.g., receipt_extraction, document_classification)', max_length=100)),
                ('field_name', models.CharField(blank=True, help_text='Specific field being reviewed', max_length=100)),
                ('original_value', models.TextField(blank=True, help_text='Original AI-extracted value')),
                ('corrected_value', models.TextField(blank=True, help_text='User-corrected value')),
                ('feedback_type', models.CharField(choices=[('CORRECT', 'Correct'), ('INCORRECT', 'Incorrect'), ('PARTIAL', 'Partially Correct'), ('UNSURE', 'Unsure')], default='UNSURE', max_length=20)),
                ('comment', models.TextField(blank=True, help_text='Additional user comments')),
                ('rating', models.IntegerField(blank=True, help_text='User rating 1-5', null=True)),
                ('ai_confidence', models.FloatField(blank=True, help_text='AI confidence score 0-1', null=True)),
                ('ai_reasoning', models.TextField(blank=True, help_text='AI reasoning for the result')),
                ('ai_alternatives', models.JSONField(blank=True, default=list, help_text='Alternative values considered')),
                ('metadata', models.JSONField(blank=True, default=dict, help_text='Additional context metadata')),
                ('source_document', models.CharField(blank=True, help_text='Source document path/URL', max_length=500)),
                ('reviewed', models.BooleanField(default=False, help_text='Whether feedback has been reviewed by admin')),
                ('reviewed_at', models.DateTimeField(blank=True, null=True)),
                ('action_taken', models.TextField(blank=True, help_text='Action taken based on feedback')),
                ('reviewed_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='reviewed_feedbacks', to=settings.AUTH_USER_MODEL)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='ai_feedbacks', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-created_at'],
                'indexes': [models.Index(fields=['result_id', 'field_name'], name='ai_assistan_result__7526c7_idx'), models.Index(fields=['result_type', 'feedback_type'], name='ai_assistan_result__caba42_idx'), models.Index(fields=['user', 'created_at'], name='ai_assistan_user_id_382382_idx')],
            },
        ),
        migrations.AddIndex(
            model_name='airequestlog',
            index=models.Index(fields=['provider', 'model', 'created_at'], name='ai_assistan_provide_65f489_idx'),
        ),
        migrations.AddIndex(
            model_name='airequestlog',
            index=models.Index(fields=['request_type', 'status', 'created_at'], name='ai_assistan_request_8ca2be_idx'),
        ),
        migrations.AddIndex(
            model_name='airequestlog',
            index=models.Index(fields=['user', 'created_at'], name='ai_assistan_user_id_1bb4eb_idx'),
        ),
        migrations.AddIndex(
            model_name='airequestlog',
            index=models.Index(fields=['tenant_id', 'created_at'], name='ai_assistan_tenant__bcf5a0_idx'),
        ),
        migrations.AddIndex(
            model_name='airequestlog',
            index=models.Index(fields=['assistant_type', 'created_at'], name='ai_assistan_assista_3954fd_idx'),
        ),
        migrations.AddIndex(
            model_name='airesultlog',
            index=models.Index(fields=['result_type', 'created_at'], name='ai_assistan_result__398852_idx'),
        ),
        migrations.AddIndex(
            model_name='airesultlog',
            index=models.Index(fields=['model_provider', 'model_name'], name='ai_assistan_model_p_fea216_idx'),
        ),
        migrations.AddIndex(
            model_name='asynctask',
            index=models.Index(fields=['user', 'status'], name='ai_assistan_user_id_9b65e2_idx'),
        ),
        migrations.AddIndex(
            model_name='asynctask',
            index=models.Index(fields=['task_type', 'status'], name='ai_assistan_task_ty_b41130_idx'),
        ),
        migrations.AddIndex(
            model_name='asynctask',
            index=models.Index(fields=['celery_task_id'], name='ai_assistan_celery__d5b63f_idx'),
        ),
        migrations.AddIndex(
            model_name='vectorsearchlog',
            index=models.Index(fields=['collection_name', 'created_at'], name='ai_assistan_collect_f014d8_idx'),
        ),
        migrations.AddIndex(
            model_name='vectorsearchlog',
            index=models.Index(fields=['user', 'created_at'], name='ai_assistan_user_id_43e926_idx'),
        ),
        migrations.AddIndex(
            model_name='vectorsearchlog',
            index=models.Index(fields=['tenant_id', 'created_at'], name='ai_assistan_tenant__6e2f02_idx'),
        ),
        migrations.AddIndex(
            model_name='vectorsearchlog',
            index=models.Index(fields=['results_count', 'created_at'], name='ai_assistan_results_7c533d_idx'),
        ),
        migrations.AddIndex(
            model_name='knowledgegaplog',
            index=models.Index(fields=['gap_type', 'is_resolved'], name='ai_assistan_gap_typ_7ef7f9_idx'),
        ),
        migrations.AddIndex(
            model_name='knowledgegaplog',
            index=models.Index(fields=['priority', 'is_resolved'], name='ai_assistan_priorit_df1278_idx'),
        ),
        migrations.AddIndex(
            model_name='knowledgegaplog',
            index=models.Index(fields=['tenant_id', 'created_at'], name='ai_assistan_tenant__29d34d_idx'),
        ),
    ]
